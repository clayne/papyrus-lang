name: GitHub CI

on:
  push:
    branches:
      - test-build
      - pull/**


jobs:
  build:
    runs-on: windows-latest
    env:
      VSIX_NAME: papyrus-lang-test-${{ github.event.repository.pushed_at }}.vsix
    steps:
    - name: Notify Build Started
      uses: rjstone/discord-webhook-notify@v1
      with:
        severity: warn
        text: >
          New test build [${{ env.GITHUB_WORKFLOW }}
          (${{ env.GITHUB_ACTION }})](https://github.com/rjstone/papyrus-lang/actions)
          started by ${{ github.actor }}.
        description: >
          ${{ github.repository }} got ${{ github.event }} for ${{ github.ref }}\n
          ${{ join(github.commits.*.message, '\n') }}
        webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
    - name: Info
      run: echo 'Ref=${{ github.event.ref }} Pusher=${{ github.event.pusher.name }} Pushed_At=${{ github.event.repository.pushed_at }}'
    - name: Checkout
      uses: actions/checkout@v1
    - name: Setup Nuget.exe
      if: success()
      uses: warrenbuckley/Setup-Nuget@v1
    - name: Update Debug
      if: success()
      uses: ecampidoglio/cake-action@v1.1.1
      with:
        target: update-debug-plugin
    - name: Update Pyro
      if: success()
      uses: ecampidoglio/cake-action@v1.1.1
      with:
        target: update-pyro-cli
    - name: Full Build (default)
      if: success()
      uses: ecampidoglio/cake-action@v1.1.1
      with:
        target: default
    - name: VSCE Package
      if: success()
      run: > 
        cd src\papyrus-lang-vscode ;
        npm install vsce ;
        mkdir artifact ;
        npx vsce package -o artifact\${{ env.VSIX_NAME }}
    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v1
      with:
        name: ${{ env.VSIX_NAME }}
        path: src\papyrus-lang-vscode\artifact\${{ env.VSIX_NAME }}

    # Notifications
    - name: Notify Success
      if: success()
      uses: rjstone/discord-webhook-notify@v1
      with:
        severity: info
        description: ${{ env.GITHUB_ACTION }} - Build Succeeded!
        webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
    - name: Notify Failure
      if: failure()
      uses: rjstone/discord-webhook-notify@v1
      with:
        severity: error
        description: ${{ env.GITHUB_ACTION }} - Build Failed!
        webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
    - name: Notify Cancelled
      if: cancelled()
      uses: rjstone/discord-webhook-notify@v1
      with:
        severity: warn
        description: ${{ env.GITHUB_ACTION }} - Build Cancelled!
        webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
